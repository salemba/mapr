---
- hosts: HistoryServer_nodes
  become: yes
  vars_files:
    - ./mapr_configuration/vars/creds.yml   
  tasks:
    - name: Notify relevant users on Slack about HistoryServer restart
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        body_format: json
        body: >
          {
            "text": "üö® *Avis Important √† l'√©quipe de d√©veloppement de donn√©es et aux administrateurs syst√®me* üö®\n\nLe HistoryServer sera red√©marr√© dans quelques instants pour maintenance. Veuillez terminer toutes les t√¢ches critiques ou sauvegarder votre travail en cours.\n\n Le red√©marrage peut affecter l'acc√®s aux historiques des jobs et les diagnostics temporairement.\n\nNous vous tiendrons inform√©s une fois la maintenance termin√©e. Merci de votre compr√©hension et coop√©ration."
          }
      delegate_to: localhost

    - name: Stop HistoryServer
      command: sudo maprcli node services -nodes {{ inventory_hostname }} -name historyserver -action stop



    - name: Notify users on Slack that HistoryServer is stopped
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        body_format: json
        body: >
          {
            "text": "üöß *Avis Important* üöß\n\nLe *HistoryServer* est actuellement arr√™t√© pour maintenance. Pendant cette p√©riode, *aucun job ex√©cut√© ne sera historis√©*. Les analyses de performance des jobs MapReduce ne seront pas disponibles jusqu'√† ce que le service soit restaur√©. Veuillez √©viter de d√©marrer des t√¢ches critiques n√©cessitant des historiques jusqu'√† nouvel ordre. Nous vous informerons d√®s la reprise du service."
          }
      delegate_to: localhost



    - name: Stop HistoryServer
      command: sudo maprcli node services -nodes {{ inventory_hostname }} -name historyserver -action start


    - name: Notify users on Slack that HistoryServer is starting
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        body_format: json
        body: >
          {
            "text": "üîÑ *Mise √† jour du serveur* üîÑ\n\nLe *HistoryServer* est actuellement en cours de red√©marrage. Vous pourriez observer des ralentissements temporaires ou des comportements inhabituels dans les analyses et le traitement des jobs MapReduce. Merci de votre patience pendant que nous finalisons la maintenance. Nous nous effor√ßons de minimiser les interruptions."
          }
      delegate_to: localhost


    - name: Check that HistoryServer is running
      shell: sudo jps | grep JobHistoryServer
      register: jps_output
      until: jps_output.stdout != ""
      retries: 10
      delay: 10
      ignore_errors: true

    - name: Notify users on Slack that HistoryServer is up and running
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        body_format: json
        body: >
          {
            "text": "üéâ *Le HistoryServer est d√©sormais op√©rationnel!* üéâ\n\nMerci pour votre patience durant cette maintenance. Tous les services sont restaur√©s, et vous pouvez d√©sormais poursuivre vos activit√©s normalement. Bonne continuation !"
          }
      delegate_to: localhost
      when: jps_output.stdout != ""

    - name: Notify users on Slack if HistoryServer failed to start
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        body_format: json
        body: >
          {
            "text": "‚ö†Ô∏è *Attention:* Le HistoryServer n'a pas pu d√©marrer correctement apr√®s plusieurs tentatives. Veuillez contacter l'√©quipe de support pour une intervention. ‚ö†Ô∏è"
          }
      delegate_to: localhost
      when: jps_output.stdout == "" and jps_output.attempts == 5
